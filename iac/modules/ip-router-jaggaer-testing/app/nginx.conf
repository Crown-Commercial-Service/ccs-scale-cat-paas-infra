worker_processes 4;
daemon off;

error_log /dev/stderr;

events {
  worker_connections 1024;
}

http {
  charset utf-8;

  log_format access_json '{"logType": "nginx-access", '
                         ' "remoteHost": "$remote_addr", '
                         ' "user": "$remote_user", '
                         ' "time": "$time_local", '
                         ' "request": "$request", '
                         ' "status": $status, '
                         ' "size": $body_bytes_sent, '
                         ' "referer": "$http_referer", '
                         ' "userAgent": "$http_user_agent", '
                         ' "requestTime": $request_time, '
                         ' "queryString": $query_string, '
                         ' "request_uri": $request_uri, '
                         ' "uri": $uri, '
                         ' "nginx_version": $nginx_version, '
                         ' "httpXCfForwardedUrl": $http_x_cf_forwarded_url, '
                         ' "httpHost": "$http_host"}';

  access_log /dev/stdout access_json;
  default_type application/octet-stream;
  sendfile on;
  tcp_nopush on;
  keepalive_timeout 30;
  port_in_redirect off;
  server_tokens off;

  expires -1;

  real_ip_header X-Forwarded-For;
  set_real_ip_from 10.0.0.0/8;
  set_real_ip_from 127.0.0.1/32;
  set_real_ip_from 172.16.0.0/12;
  set_real_ip_from 192.168.0.0/16;
  real_ip_recursive on;
  client_max_body_size {{env "CLIENT_MAX_BODY_SIZE"}};

  server {
    listen {{ port }};
    server_name localhost;

    satisfy any;

    error_page 403 = @forbidden;

    location @forbidden {
      allow all;
      access_log off;

      default_type text/plain;
      return 403 'Forbidden by {{ env "APP_NAME" }}';
    }

    location @check {
      default_type text/plain;
      return 200 'OK';
    }

    location = /_route-service-health {
      allow all;
      access_log off;

      stub_status on;
      access_log off;
    }

    location = /_route-service-check {
      allow 127.0.0.1/32;
      {{env "ALLOWED_IPS"}}
      deny all;

      try_files $uri @check;
    }

    location / {
      allow 127.0.0.1/32;
      {{env "ALLOWED_IPS"}}
      deny all;

      resolver 169.254.0.2;

      set $cf_forwarded_host '*';
      set $cf_forwarded_uri '*';

      set $publish_endpoint_throw_404 {{env "PUBLISH_ENDPOINT_THROW_404"}};
      set $publish_endpoint_throw_502 {{ env "PUBLISH_ENDPOINT_THROW_502"}};
      set $publish_endpoint_throw_503 {{ env "PUBLISH_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxworkflows/publish.*) {
        set $publish_endpoint_exception "0";
      }

      if ($publish_endpoint_throw_404 ~ .*true.*) {
        set $publish_endpoint_exception "${publish_endpoint_exception}404";
      }

      if ($publish_endpoint_throw_502 ~ .*true.*) {
        set $publish_endpoint_exception "${publish_endpoint_exception}502";
      }

      if ($publish_endpoint_throw_503 ~ .*true.*) {
        set $publish_endpoint_exception "${publish_endpoint_exception}503";
      }

      if ($publish_endpoint_exception = "0404") {
        return 404;
      }

      if ($publish_endpoint_exception = "0502") {
        return 502;
      }

      if ($publish_endpoint_exception = "0503") {
        return 503;
      }

      set $messages_endpoint_throw_404 {{env "MESSAGES_ENDPOINT_THROW_404"}};
      set $messages_endpoint_throw_502 {{ env "MESSAGES_ENDPOINT_THROW_502"}};
      set $messages_endpoint_throw_503 {{ env "MESSAGES_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/messages.*) {
        set $messages_endpoint_exception "0";
      }

      if ($messages_endpoint_throw_404 ~ .*true.*) {
        set $messages_endpoint_exception "${messages_endpoint_exception}404";
      }

      if ($messages_endpoint_throw_502 ~ .*true.*) {
        set $messages_endpoint_exception "${messages_endpoint_exception}502";
      }

      if ($messages_endpoint_throw_503 ~ .*true.*) {
        set $messages_endpoint_exception "${messages_endpoint_exception}503";
      }

      if ($messages_endpoint_exception = "0404") {
        return 404;
      }

      if ($messages_endpoint_exception = "0502") {
        return 502;
      }

      if ($messages_endpoint_exception = "0503") {
        return 503;
      }

      set $messages_read_endpoint_throw_404 {{env "MESSAGES_READ_ENDPOINT_THROW_404"}};
      set $messages_read_endpoint_throw_502 {{ env "MESSAGES_READ_ENDPOINT_THROW_502"}};
      set $messages_read_endpoint_throw_503 {{ env "MESSAGES_READ_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/messages/read.*) {
        set $messages_read_endpoint_exception "0";
      }

      if ($messages_read_endpoint_throw_404 ~ .*true.*) {
        set $messages_read_endpoint_exception "${messages_read_endpoint_exception}404";
      }

      if ($messages_read_endpoint_throw_502 ~ .*true.*) {
        set $messages_read_endpoint_exception "${messages_read_endpoint_exception}502";
      }

      if ($messages_read_endpoint_throw_503 ~ .*true.*) {
        set $messages_read_endpoint_exception "${messages_read_endpoint_exception}503";
      }

      if ($messages_read_endpoint_exception = "0404") {
        return 404;
      }

      if ($messages_read_endpoint_exception = "0502") {
        return 502;
      }

      if ($messages_read_endpoint_exception = "0503") {
        return 503;
      }

      set $evaluations_start_endpoint_throw_404 {{env "EVALUATIONS_START_ENDPOINT_THROW_404"}};
      set $evaluations_start_endpoint_throw_502 {{ env "EVALUATIONS_START_ENDPOINT_THROW_502"}};
      set $evaluations_start_endpoint_throw_503 {{ env "EVALUATIONS_START_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxworkflows/evaluations/start.*) {
        set $evaluations_start_endpoint_exception "0";
      }

      if ($evaluations_start_endpoint_throw_404 ~ .*true.*) {
        set $evaluations_start_endpoint_exception "${evaluations_start_endpoint_exception}404";
      }

      if ($evaluations_start_endpoint_throw_502 ~ .*true.*) {
        set $evaluations_start_endpoint_exception "${evaluations_start_endpoint_exception}502";
      }

      if ($evaluations_start_endpoint_throw_503 ~ .*true.*) {
        set $evaluations_start_endpoint_exception "${evaluations_start_endpoint_exception}503";
      }

      if ($evaluations_start_endpoint_exception = "0404") {
        return 404;
      }

      if ($evaluations_start_endpoint_exception = "0502") {
        return 502;
      }

      if ($evaluations_start_endpoint_exception = "0503") {
        return 503;
      }

      set $evaluations_open_envelope_endpoint_throw_404 {{env "EVALUATIONS_OPEN_ENVELOPE_ENDPOINT_THROW_404"}};
      set $evaluations_open_envelope_endpoint_throw_502 {{ env "EVALUATIONS_OPEN_ENVELOPE_ENDPOINT_THROW_502"}};
      set $evaluations_open_envelope_endpoint_throw_503 {{ env "EVALUATIONS_OPEN_ENVELOPE_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxworkflows/evaluations/openEnvelope.*) {
        set $evaluations_open_envelope_endpoint_exception "0";
      }

      if ($evaluations_open_envelope_endpoint_throw_404 ~ .*true.*) {
        set $evaluations_open_envelope_endpoint_exception "${evaluations_open_envelope_endpoint_exception}404";
      }

      if ($evaluations_open_envelope_endpoint_throw_502 ~ .*true.*) {
        set $evaluations_open_envelope_endpoint_exception "${evaluations_open_envelope_endpoint_exception}502";
      }

      if ($evaluations_open_envelope_endpoint_throw_503 ~ .*true.*) {
        set $evaluations_open_envelope_endpoint_exception "${evaluations_open_envelope_endpoint_exception}503";
      }

      if ($evaluations_open_envelope_endpoint_exception = "0404") {
        return 404;
      }

      if ($evaluations_open_envelope_endpoint_exception = "0502") {
        return 502;
      }

      if ($evaluations_open_envelope_endpoint_exception = "0503") {
        return 503;
      }

      if ($http_x_cf_forwarded_url ~* ^(https?\:\/\/)(.*?)\/(.*)$) {
        set $cf_forwarded_host $2;
        set $cf_forwarded_uri /$3;
      }

      set $scores_endpoint_throw_404 {{env "SCORES_ENDPOINT_THROW_404"}};
      set $scores_endpoint_throw_502 {{ env "SCORES_ENDPOINT_THROW_502"}};
      set $scores_endpoint_throw_503 {{ env "SCORES_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxs/scores.*) {
        set $scores_endpoint_exception "0";
      }

      if ($scores_endpoint_throw_404 ~ .*true.*) {
        set $scores_endpoint_exception "${scores_endpoint_exception}404";
      }

      if ($scores_endpoint_throw_502 ~ .*true.*) {
        set $scores_endpoint_exception "${scores_endpoint_exception}502";
      }

      if ($scores_endpoint_throw_503 ~ .*true.*) {
        set $scores_endpoint_exception "${scores_endpoint_exception}503";
      }

      if ($scores_endpoint_exception = "0404") {
        return 404;
      }

      if ($scores_endpoint_exception = "0502") {
        return 502;
      }

      if ($scores_endpoint_exception = "0503") {
        return 503;
      }

      set $complete_technical_endpoint_throw_404 {{env "COMPLETE_TECHNICAL_ENDPOINT_THROW_404"}};
      set $complete_technical_endpoint_throw_502 {{ env "COMPLETE_TECHNICAL_ENDPOINT_THROW_502"}};
      set $complete_technical_endpoint_throw_503 {{ env "COMPLETE_TECHNICAL_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxworkflows/completetechnical.*) {
        set $complete_technical_endpoint_exception "0";
      }

      if ($complete_technical_endpoint_throw_404 ~ .*true.*) {
        set $complete_technical_endpoint_exception "${complete_technical_endpoint_exception}404";
      }

      if ($complete_technical_endpoint_throw_502 ~ .*true.*) {
        set $complete_technical_endpoint_exception "${complete_technical_endpoint_exception}502";
      }

      if ($complete_technical_endpoint_throw_503 ~ .*true.*) {
        set $complete_technical_endpoint_exception "${complete_technical_endpoint_exception}503";
      }

      if ($complete_technical_endpoint_exception = "0404") {
        return 404;
      }

      if ($complete_technical_endpoint_exception = "0502") {
        return 502;
      }

      if ($complete_technical_endpoint_exception = "0503") {
        return 503;
      }

      set $preaward_rfx_endpoint_throw_404 {{env "PREAWARD_RFX_ENDPOINT_THROW_404"}};
      set $preaward_rfx_endpoint_throw_502 {{ env "PREAWARD_RFX_ENDPOINT_THROW_502"}};
      set $preaward_rfx_endpoint_throw_503 {{ env "PREAWARD_RFX_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxworkflows/preawardRfx.*) {
        set $preaward_rfx_endpoint_exception "0";
      }

      if ($preaward_rfx_endpoint_throw_404 ~ .*true.*) {
        set $preaward_rfx_endpoint_exception "${preaward_rfx_endpoint_exception}404";
      }

      if ($preaward_rfx_endpoint_throw_502 ~ .*true.*) {
        set $preaward_rfx_endpoint_exception "${preaward_rfx_endpoint_exception}502";
      }

      if ($preaward_rfx_endpoint_throw_503 ~ .*true.*) {
        set $preaward_rfx_endpoint_exception "${preaward_rfx_endpoint_exception}503";
      }

      if ($preaward_rfx_endpoint_exception = "0404") {
        return 404;
      }

      if ($preaward_rfx_endpoint_exception = "0502") {
        return 502;
      }

      if ($preaward_rfx_endpoint_exception = "0503") {
        return 503;
      }

      set $rfxs_endpoint_throw_404 {{env "RFXS_ENDPOINT_THROW_404"}};
      set $rfxs_endpoint_throw_502 {{ env "RFXS_ENDPOINT_THROW_502"}};
      set $rfxs_endpoint_throw_503 {{ env "RFXS_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxs/.*) {
        set $rfxs_endpoint_exception "0";
      }

      if ($rfxs_endpoint_throw_404 ~ .*true.*) {
        set $rfxs_endpoint_exception "${rfxs_endpoint_exception}404";
      }

      if ($rfxs_endpoint_throw_502 ~ .*true.*) {
        set $rfxs_endpoint_exception "${rfxs_endpoint_exception}502";
      }

      if ($rfxs_endpoint_throw_503 ~ .*true.*) {
        set $rfxs_endpoint_exception "${rfxs_endpoint_exception}503";
      }

      if ($rfxs_endpoint_exception = "0404") {
        return 404;
      }

      if ($rfxs_endpoint_exception = "0502") {
        return 502;
      }

      if ($rfxs_endpoint_exception = "0503") {
        return 503;
      }

      set $award_rfx_endpoint_throw_404 {{env "AWARD_RFX_ENDPOINT_THROW_404"}};
      set $award_rfx_endpoint_throw_502 {{ env "AWARD_RFX_ENDPOINT_THROW_502"}};
      set $award_rfx_endpoint_throw_503 {{ env "AWARD_RFX_ENDPOINT_THROW_503"}};

      if ($http_x_cf_forwarded_url ~ .*/esop/jint/api/public/ja/v1/rfxworkflows/awardRfx.*) {
        set $award_rfx_endpoint_exception "0";
      }

      if ($award_rfx_endpoint_throw_404 ~ .*true.*) {
        set $award_rfx_endpoint_exception "${award_rfx_endpoint_exception}404";
      }

      if ($award_rfx_endpoint_throw_502 ~ .*true.*) {
        set $award_rfx_endpoint_exception "${award_rfx_endpoint_exception}502";
      }

      if ($award_rfx_endpoint_throw_503 ~ .*true.*) {
        set $award_rfx_endpoint_exception "${award_rfx_endpoint_exception}503";
      }

      if ($award_rfx_endpoint_exception = "0404") {
        return 404;
      }

      if ($award_rfx_endpoint_exception = "0502") {
        return 502;
      }

      if ($award_rfx_endpoint_exception = "0503") {
        return 503;
      }

      proxy_http_version 1.1;
      proxy_ssl_server_name on;
      proxy_ssl_protocols TLSv1.2;
      proxy_set_header Connection "";
      proxy_set_header Host $cf_forwarded_host;
      proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
      proxy_read_timeout 180s;

      # Use XX-CF-APP-INSTANCE on the original request if you wish to target an instance
      proxy_set_header X-CF-APP-INSTANCE $http_xx_cf_app_instance;

      proxy_pass $http_x_forwarded_proto://$http_host$cf_forwarded_uri;
    }
  }
}
